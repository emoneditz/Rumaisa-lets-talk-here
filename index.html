<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Modern Chat - Persistent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Variables for easier theme management */
        :root {
            --bubble-me: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            --bubble-rumaisa: rgba(255, 255, 255, 0.5);
            --bubble-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --glass-bg: rgba(255, 255, 255, 0.5);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Use dynamic viewport unit to better handle mobile keyboard */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #a1c4fd 100%);
        }

        /* Chat Container */
        .chat-container {
            width: 100vw;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: transparent;
        }

        /* Chat Header with Liquid Glass effect */
        .chat-header {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            color: #333;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 30;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Chat Messages Box - Now flex: 1 to fill space */
        .chat-box {
            flex: 1;
            padding: 1rem;
            /* Add extra bottom padding so messages are never hidden under the fixed input */
            padding-bottom: calc(1rem + 5.75rem + env(safe-area-inset-bottom, 0));
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
            background: transparent;
        }

        /* Message Bubble Styles */
        .message {
            max-width: 80%;
            margin: 0.5rem 0;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            clear: both;
            word-wrap: break-word;
            position: relative;
            animation: messageSlide 0.4s cubic-bezier(0.23, 1, 0.320, 1) forwards;
            box-shadow: var(--bubble-shadow);
            white-space: pre-wrap;
        }

        .me { background: var(--bubble-me); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 0.5rem; }
        .rumaisa { background-color: var(--bubble-rumaisa); color: #333; margin-right: auto; text-align: left; border-bottom-left-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); }

        .message-time { font-size: 0.65rem; opacity: 0.7; margin-top: 0.25rem; float: right; margin-left: 1rem; }

        .media { max-width: 100%; border-radius: 0.75rem; margin-top: 0.5rem; margin-bottom: 0.25rem; cursor: pointer; object-fit: contain; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .media-video { width: 100%; max-height: 250px; border-radius: 0.75rem; margin-top: 0.5rem; margin-bottom: 0.25rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .file-message { display: flex; align-items: center; padding: 0.75rem; background-color: #f1f5f9; border-radius: 0.75rem; margin-top: 0.5rem; margin-bottom: 0.25rem; cursor: pointer; transition: background-color 0.2s; }
        .file-message:hover { background-color: #eef2ff; }
        .file-icon { font-size: 1.5rem; margin-right: 0.75rem; color: #3b82f6; }

        /* Input bar fixed to the bottom to avoid being pushed under mobile keyboard */
        .input-box {
            position: fixed;
            left: 0;
            right: 0;
            bottom: env(safe-area-inset-bottom, 0);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--glass-border);
            flex-shrink: 0;
            z-index: 50;
            /* small shadow so it visually floats above chat */
            box-shadow: 0 -6px 18px rgba(0,0,0,0.06);
        }

        .input-content-wrapper { display: flex; align-items: flex-end; width: 100%; max-width: 800px; gap: 0.5rem; padding: 0 0.5rem; }

        .input-area-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* This wrapper now takes up available space */
            gap: 0.5rem;
        }

        .message-input-wrapper { flex: 1; display: flex; align-items: center; background-color: rgba(255, 255, 255, 0.9); border-radius: 1.5rem; border: 1px solid rgba(0, 0, 0, 0.05); min-height: 2.5rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1); }

        .message-input { flex: 1; border: none; background: transparent; padding: 0.5rem 0.75rem; font-size: 1rem; outline: none; resize: none; max-height: 8rem; }

        .send-button { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: var(--bubble-me); color: white; font-size: 1.25rem; transition: all 0.2s ease-in-out; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); flex-shrink: 0; /* Prevents button from shrinking */ }
        .send-button:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4); }
        .send-button:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; }

        .plus-button { width: 2.25rem; height: 2.25rem; display: flex; justify-content: center; align-items: center; border-radius: 50%; color: #9ca3af; transition: all 0.2s ease; }
        .plus-button:hover { background-color: #e5e7eb; color: #3b82f6; }

        /* File info bar styles */
        .file-info-bar {
            display: none;
            width: 100%;
            padding: 0.5rem;
            background-color: #f0f4f8;
            border-radius: 1rem;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease-in-out;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            animation: fadeIn 0.3s forwards;
        }

        .file-info-bar.show {
            display: flex;
        }

        .file-details {
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            flex: 1;
        }

        .file-details .file-icon {
            font-size: 1rem;
            margin-right: 0.5rem;
            color: #3b82f6;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .file-size {
            color: #6b7280;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

        .file-close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
            padding: 0.25rem;
            transition: color 0.2s;
        }

        .file-close-btn:hover {
            color: #ef4444;
        }

        /* Message sent notification pop-up */
        #sentNotification {
            position: fixed;
            top: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            color: #333;
            font-weight: 600;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s;
            opacity: 0;
        }

        #sentNotification.show {
            top: 1rem;
            opacity: 1;
        }

        @keyframes messageSlide { from { transform: translateY(1rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .modal-container { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { max-width: 90vw; max-height: 90vh; animation: zoomIn 0.3s; }
        .close-modal-btn { position: absolute; top: 1rem; right: 2rem; color: white; font-size: 2rem; font-weight: bold; cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.8); } to { transform: scale(1); } }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <h3 class="font-bold text-lg tracking-wide">ðŸ’¬ Hello Miss Rumaisa </h3>
        <!-- New Online/Offline status section -->
        <div class="mt-2 text-sm font-semibold flex items-center gap-2">
            <button id="statusBtn" class="px-3 py-1 bg-blue-500 text-white rounded-full shadow-md hover:bg-blue-600 transition-colors duration-200">
                Click here to see Online
            </button>
            <span id="statusIndicator" class="hidden">
                <i id="statusIcon" class="fas fa-circle text-gray-400"></i>
                <span id="statusText" class="ml-1 text-gray-500">Offline</span>
            </span>
        </div>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="load-more text-center text-blue-500 p-3 cursor-pointer hover:bg-blue-50 transition-all duration-300 rounded-lg" id="loadMore" style="display: none;">
            <i class="fas fa-arrow-up mr-2"></i>Load older messages
        </div>
    </div>

    <!-- Message sent notification -->
    <div id="sentNotification">
        <i id="sentIcon" class="fas fa-check-circle text-green-500"></i>
        <span id="sentMessage">Message sent!</span>
    </div>

    <!-- Fixed input box now stays above keyboard and screen safe area -->
    <div class="input-box" id="inputBox">
        <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
        <div class="input-content-wrapper">
            <!-- New wrapper div to contain the file info bar and the text input -->
            <div class="input-area-container">
                <!-- File information bar -->
                <div id="fileInfoBar" class="file-info-bar">
                    <div class="file-details">
                        <i id="fileIcon" class="file-icon"></i>
                        <span id="fileName" class="file-name"></span>
                        <span id="fileSize" class="file-size"></span>
                    </div>
                    <button id="fileCloseBtn" class="file-close-btn" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Original input container, now inside the new wrapper -->
                <div class="message-input-wrapper">
                    <button type="button" class="plus-button" onclick="openFileDialog()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="msg" class="message-input" placeholder="Type a message..." rows="1"></textarea>
                </div>
            </div>
            <button type="button" class="send-button" onclick="sendMessage()" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

</div>

<div class="modal-container" id="modalContainer">
    <span class="close-modal-btn" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="fullImage" src="" alt="Full size image">
</div>

<script>
    const TOKEN = "8373355359:AAF0b7kWG2mNFv0qBYt2YTjvW5mD6eSBCuw";
    const CHAT_ID = "6009819572"; // My chat ID
    const RUMAISA_ID = "6009819572"; // Assuming "Rumaisa" is the same user ID for this test
    const chatBox = document.getElementById('chatBox');
    const loadMoreBtn = document.getElementById('loadMore');
    const modalContainer = document.getElementById('modalContainer');
    const fullImage = document.getElementById('fullImage');
    const fileInput = document.getElementById('fileInput');
    const fileInfoBar = document.getElementById('fileInfoBar');
    const fileNameDisplay = document.getElementById('fileName');
    const fileSizeDisplay = document.getElementById('fileSize');
    const fileIconDisplay = document.getElementById('fileIcon');
    const fileCloseBtn = document.getElementById('fileCloseBtn');
    const messageInput = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const sentNotification = document.getElementById('sentNotification');
    const sentMessage = document.getElementById('sentMessage');
    const sentIcon = document.getElementById('sentIcon');
    const statusBtn = document.getElementById('statusBtn');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    let chatHistory = [];
    let historyOffset = 0;
    let isLoadingHistory = false;
    let lastUpdateId = 0;
    let initialLoadComplete = false;
    let isCheckingStatus = false;
    let statusCheckInterval = null;
    let statusCheckTimeout = null;

    // Switched from sessionStorage to localStorage for chat persistence
    function loadChatHistory() {
        const saved = localStorage.getItem('telegram_chat_history');
        if (saved) chatHistory = JSON.parse(saved);
        displayRecentMessages(20);
    }

    // Switched from sessionStorage to localStorage for chat persistence
    function saveChatHistory() {
        // Limit the chat history to the last 50 messages
        if (chatHistory.length > 50) {
            chatHistory = chatHistory.slice(chatHistory.length - 50);
        }
        localStorage.setItem('telegram_chat_history', JSON.stringify(chatHistory));
    }

    function displayRecentMessages(count = 20) {
        const recentMessages = chatHistory.slice(-count);
        let currentDate = '';
        const existingMessages = chatBox.querySelectorAll('.message, .date-separator');
        existingMessages.forEach(msg => msg.remove());
        recentMessages.forEach(msg => {
            const messageDate = new Date(msg.timestamp).toDateString();
            if (messageDate !== currentDate) {
                addDateSeparator(messageDate);
                currentDate = messageDate;
            }
            displayMessage(msg, false);
        });
        if (chatHistory.length > count) { loadMoreBtn.style.display = 'block'; historyOffset = count; } else { loadMoreBtn.style.display = 'none'; }
        initialLoadComplete = true;
        setTimeout(() => scrollToBottom(), 500);
    }

    function addDateSeparator(dateStr) {
        const separator = document.createElement('div');
        separator.classList.add('date-separator', 'text-center', 'my-4', 'relative');
        separator.innerHTML = `
            <span class="bg-gray-200 text-gray-600 text-xs px-4 py-2 rounded-full relative z-10 shadow-sm">
                ${dateStr}
            </span>
            <div class="absolute inset-x-0 top-1/2 h-px bg-gray-300 -z-0"></div>
        `;
        chatBox.insertBefore(separator, chatBox.firstChild);
    }

    function loadOlderMessages() {
        if (isLoadingHistory || historyOffset >= chatHistory.length) return;
        isLoadingHistory = true;
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading older messages...';
        loadMoreBtn.classList.add('loading');
        setTimeout(() => {
            const oldScrollHeight = chatBox.scrollHeight;
            const messagesToLoad = 20;
            const startIndex = Math.max(0, chatHistory.length - historyOffset - messagesToLoad);
            const endIndex = chatHistory.length - historyOffset;
            if (startIndex < endIndex) {
                const olderMessages = chatHistory.slice(startIndex, endIndex);
                let currentDate = '';
                olderMessages.reverse().forEach(msg => {
                    const messageDate = new Date(msg.timestamp).toDateString();
                    if (messageDate !== currentDate) { addDateSeparator(messageDate); currentDate = messageDate; }
                    displayMessage(msg, true);
                });
                historyOffset += messagesToLoad;
                chatBox.scrollTop = chatBox.scrollHeight - oldScrollHeight;
            }
            if (historyOffset >= chatHistory.length) loadMoreBtn.style.display = 'none'; else { loadMoreBtn.innerHTML = '<i class="fas fa-arrow-up mr-2"></i>Load older messages'; loadMoreBtn.classList.remove('loading'); }
            isLoadingHistory = false;
        }, 800);
    }

    function showSentStatus(message, type = 'success') {
        sentMessage.textContent = message;
        sentIcon.className = type === 'success' ? 'fas fa-check-circle text-green-500' : 'fas fa-exclamation-circle text-red-500';
        sentNotification.classList.add('show');
        setTimeout(() => {
            sentNotification.classList.remove('show');
        }, 3000);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const icons = { pdf: 'fa-solid fa-file-pdf', doc: 'fa-solid fa-file-word', docx: 'fa-solid fa-file-word', txt: 'fa-solid fa-file-lines', jpg: 'fa-solid fa-image', jpeg: 'fa-solid fa-image', png: 'fa-solid fa-image', gif: 'fa-solid fa-image', webp: 'fa-solid fa-image', mp4: 'fa-solid fa-file-video', avi: 'fa-solid fa-file-video', mov: 'fa-solid fa-file-video', mkv: 'fa-solid fa-file-video', mp3: 'fa-solid fa-file-audio', wav: 'fa-solid fa-file-audio', m4a: 'fa-solid fa-file-audio', flac: 'fa-solid fa-file-audio', zip: 'fa-solid fa-file-zipper', rar: 'fa-solid fa-file-zipper', '7z': 'fa-solid fa-file-zipper' };
        return icons[ext] || 'fa-solid fa-file';
    }

    // New helper function to convert GMT timestamp to your local GMT+6
    function getGMTPlus6Time(unixTimestamp) {
        const date = new Date(unixTimestamp * 1000);
        // Add 6 hours to the UTC time
        const offsetInMinutes = date.getTimezoneOffset(); // get offset in minutes
        const localTime = date.getTime();
        const utcTime = localTime + offsetInMinutes * 60 * 1000;
        const gmtPlus6 = utcTime + (6 * 60 * 60 * 1000);
        return new Date(gmtPlus6);
    }

    function displayMessage(messageData, prepend = false) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', messageData.sender);
        if (messageData.mediaUrl) {
            if (messageData.mediaType === 'image') {
                const media = document.createElement('img');
                media.src = messageData.mediaUrl;
                media.classList.add('media');
                media.loading = 'lazy';
                media.alt = messageData.text || 'Image';
                media.onclick = () => openImageModal(messageData.mediaUrl);
                msgDiv.appendChild(media);
            } else if (messageData.mediaType === 'video') {
                // Handle video display
                const video = document.createElement('video');
                video.src = messageData.mediaUrl;
                video.classList.add('media-video');
                video.controls = true; // Add playback controls
                video.playsinline = true; // For better mobile experience
                msgDiv.appendChild(video);
            } else {
                // Handle other file types
                const fileDiv = document.createElement('div');
                fileDiv.classList.add('file-message');
                fileDiv.innerHTML = `
                    <i class="${getFileIcon(messageData.fileName || 'file')} file-icon"></i>
                    <div class="file-info">
                        <div class="font-semibold">${messageData.fileName || 'File'}</div>
                        <div class="text-xs text-gray-500">${messageData.fileSize ? formatFileSize(messageData.fileSize) : ''}</div>
                    </div>
                `;
                msgDiv.appendChild(fileDiv);
            }
            if (messageData.text) {
                const textDiv = document.createElement('div');
                textDiv.textContent = messageData.text;
                textDiv.classList.add('mt-2');
                msgDiv.appendChild(textDiv);
            }
        } else if (messageData.text) {
            msgDiv.textContent = messageData.text;
        }
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('message-time', 'text-gray-400');
        
        // Use the corrected timestamp for display and format it to 12-hour style
        const displayDate = new Date(messageData.timestamp);
        timeDiv.textContent = displayDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        msgDiv.appendChild(timeDiv);
        if (prepend) chatBox.insertBefore(msgDiv, chatBox.firstChild); else chatBox.appendChild(msgDiv);
    }

    // Now uses an optional timestamp parameter
    function addMessage(text, sender, mediaUrl = null, mediaType = 'image', fileName = null, fileSize = null, timestamp = Date.now()) {
        const messageData = { text, sender, mediaUrl, mediaType, fileName, fileSize, timestamp, id: Date.now() + Math.random() };
        chatHistory.push(messageData);
        saveChatHistory();
        displayMessage(messageData);
        if (initialLoadComplete) setTimeout(() => scrollToBottom(), 100);
    }

    function openImageModal(imageUrl) { fullImage.src = imageUrl; modalContainer.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    function closeModal() { modalContainer.style.display = 'none'; document.body.style.overflow = 'auto'; }
    function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }
    function openFileDialog() { document.getElementById('fileInput').click(); }

    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 128) + 'px';
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        const file = fileInput.files[0];
        if (file) { sendFile(); return; }
        if (!message) return;
        
        // Send messages created by 'me' with the local timestamp
        addMessage(message, 'me');

        messageInput.value = '';
        autoResizeTextarea();
        fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: CHAT_ID, text: message })
        })
        .then(res => res.json())
        .then(data => { if (data.ok) showSentStatus('Message sent!'); else throw new Error(data.description || 'Failed to send'); })
        .catch(err => { console.error('Error:', err); showSentStatus('Failed to send message', 'error'); });
    }

    function sendFile() {
        const file = fileInput.files[0];
        if (!file) { showSentStatus('No file selected!', 'error'); return; }

        const isImage = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/');
        const mediaType = isImage ? 'image' : (isVideo ? 'video' : 'document');
        const localUrl = URL.createObjectURL(file);
        const fileName = file.name;
        const fileSize = file.size;

        // Add message to local chat history immediately
        addMessage('', 'me', localUrl, mediaType, fileName, fileSize);

        const formData = new FormData();
        formData.append("chat_id", CHAT_ID);
        let endpoint, fieldName;
        if (isImage) {
            endpoint = 'sendPhoto';
            fieldName = 'photo';
        } else if (isVideo) {
            endpoint = 'sendVideo';
            fieldName = 'video';
        } else {
            endpoint = 'sendDocument';
            fieldName = 'document';
        }
        formData.append(fieldName, file);

        fetch(`https://api.telegram.org/bot${TOKEN}/${endpoint}`, { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                showSentStatus('File uploaded!');
            } else {
                throw new Error(data.description || 'Failed to upload file');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showSentStatus('Failed to upload file', 'error');
        });

        clearFileSelection();
    }

    function updateSendButton() {
        const hasText = messageInput.value.trim().length > 0;
        const hasFile = fileInput.files.length > 0;
        sendBtn.disabled = !(hasText || hasFile);
    }

    function clearFileSelection() {
        fileInput.value = '';
        fileInfoBar.classList.remove('show');
        updateSendButton();
    }

    function confirmStatusOnline() {
        // Clear both the interval and the timeout
        clearInterval(statusCheckInterval);
        clearTimeout(statusCheckTimeout);
        isCheckingStatus = false;
        
        // Update the UI immediately
        statusText.textContent = 'Online';
        statusIcon.classList.remove('text-gray-400', 'text-red-500');
        statusIcon.classList.add('text-green-500');

        statusBtn.disabled = false;
        statusBtn.innerHTML = 'Click here to see Online';
    }

    function confirmStatusOffline() {
        statusText.textContent = 'Offline';
        statusIcon.classList.remove('text-gray-400', 'text-green-500');
        statusIcon.classList.add('text-red-500');
        statusBtn.disabled = false;
        statusBtn.innerHTML = 'Click here to see Online';
        isCheckingStatus = false;
    }

    async function checkStatus() {
        if (isCheckingStatus) return;
        isCheckingStatus = true;
        statusBtn.disabled = true;

        statusBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        statusIndicator.classList.remove('hidden');
        statusText.textContent = 'Checking...';
        statusIcon.classList.remove('text-green-500', 'text-red-500');
        statusIcon.classList.add('text-gray-400');

        // Step 1: Send the message to trigger a response
        await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: CHAT_ID, text: "Are you online?" })
        }).catch(err => console.error("Failed to send status message:", err));

        // Step 2: Start a timed poll to check for a reply
        statusCheckTimeout = setTimeout(() => {
            console.log("Status check timed out.");
            confirmStatusOffline();
        }, 30000); // 30 seconds

        statusCheckInterval = setInterval(async () => {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=5`);
                const data = await response.json();

                if (data.ok && data.result.length > 0) {
                    for (const update of data.result) {
                        lastUpdateId = update.update_id;
                        const message = update.message;
                        if (message && message.from.id == RUMAISA_ID) {
                            const messageText = (message.text || '').toLowerCase();
                            if (messageText.includes('yes') || messageText.includes('yeah') || messageText.includes('i am online')) {
                                console.log("Online status confirmed by response.");
                                confirmStatusOnline();
                                return; // Exit the function to stop further checking
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Status check polling failed:", error);
            }
        }, 1000); // Poll every second for new messages
    }

    function pollMessages() {
        // This is the main chat message polling loop
        if (isCheckingStatus) {
            setTimeout(pollMessages, 1000);
            return;
        }

        fetch(`https://api.telegram.org/bot${TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=30`)
            .then(res => res.json())
            .then(data => {
                if (data.ok && data.result.length > 0) {
                    data.result.forEach(update => {
                        lastUpdateId = update.update_id;
                        const message = update.message;
                        if (message) {
                            const text = message.text || message.caption || '';
                            const photo = message.photo;
                            const video = message.video;
                            const document = message.document;
                            const telegramTimestamp = message.date * 1000; // Corrected timestamp
                            if (text && !photo && !document && !video) addMessage(text, 'rumaisa', null, null, null, null, telegramTimestamp);
                            else if (photo) {
                                const largestPhoto = photo[photo.length - 1];
                                fetch(`https://api.telegram.org/bot${TOKEN}/getFile?file_id=${largestPhoto.file_id}`)
                                    .then(res => res.json())
                                    .then(fileData => { if (fileData.ok) { const photoUrl = `https://api.telegram.org/file/bot${TOKEN}/${fileData.result.file_path}`; addMessage(text, 'rumaisa', photoUrl, 'image', null, null, telegramTimestamp); } });
                            } else if (video) {
                                fetch(`https://api.telegram.org/bot${TOKEN}/getFile?file_id=${video.file_id}`)
                                    .then(res => res.json())
                                    .then(fileData => { if (fileData.ok) { const videoUrl = `https://api.telegram.org/file/bot${TOKEN}/${fileData.result.file_path}`; addMessage(text, 'rumaisa', videoUrl, 'video', video.file_name, video.file_size, telegramTimestamp); } });
                            } else if (document) addMessage(text, 'rumaisa', null, 'document', document.file_name, document.file_size, telegramTimestamp);
                        }
                    });
                }
                setTimeout(pollMessages, 1000);
            })
            .catch(err => { console.error('Polling error:', err); setTimeout(pollMessages, 5000); });
    }

    loadMoreBtn.addEventListener('click', loadOlderMessages);
    messageInput.addEventListener('input', function() { autoResizeTextarea(); updateSendButton(); });
    messageInput.addEventListener('keypress', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    statusBtn.addEventListener('click', checkStatus);

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const fileName = file.name;
            // Truncate the filename to the first 7 characters and add ellipsis
            const truncatedName = fileName.length > 7 ? fileName.substring(0, 7) + '...' : fileName;
            fileNameDisplay.textContent = truncatedName;
            fileSizeDisplay.textContent = formatFileSize(file.size);
            fileIconDisplay.className = getFileIcon(file.name);
            fileInfoBar.classList.add('show');
        } else {
            fileInfoBar.classList.remove('show');
        }
        updateSendButton();
    });

    fileCloseBtn.addEventListener('click', clearFileSelection);
    chatBox.addEventListener('scroll', function() { if (chatBox.scrollTop === 0 && !isLoadingHistory && loadMoreBtn.style.display !== 'none') { loadOlderMessages(); } });

    // When virtual keyboard opens on mobile the visual viewport resizes. Adjust scroll so input stays visible
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', function() {
            // small timeout to let layout settle
            setTimeout(() => { scrollToBottom(); }, 50);
        });
    }

    // Initial setup
    loadChatHistory();
    pollMessages();
    updateSendButton();
</script>

</body>
</html>
